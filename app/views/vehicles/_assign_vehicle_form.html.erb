<div class="col-md-12" , style="padding-bottom: 10px;">
  <%= form_tag('/vehicles/assign_vehicle', method: :post, class: 'form-inline')  do %>
      <div class="form-group">
        <label>Select date</label>
        <%= text_field_tag :start_date, Date.today.strftime('%d/%m/%Y'), class: 'datepicker', placeholder: 'From'%>
      </div>

      <div class="form-group">
        <label>Select Vehicle</label>
        <%#= select_tag :vehicle_id, options_for_select(Vehicle.all.collect {|p| [ p[:vehicle_number], p[:id] ] }, :include_blank => true) %>
        <%= select_tag :vehicle_id, options_for_select(Vehicle.all.collect {|p| [ p[:vehicle_number], p[:id] ]}), :include_blank => true  %>
        <select name="user_id" id="user_id" class="hidden"></select>
      </div>

      <%= submit_tag 'Go', class:'btn btn-primary disabled', style: 'margin-top:3%;', id: 'submit_button' %>
  <% end %>
</div>

<div class="col-md-12">
  <table class="table table-striped">
    <thead>
    <th></th>
    <th><%= Date.today.strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 1.day).strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 2.day).strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 3.day).strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 4.day).strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 5.day).strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 6.day).strftime('%d/%m/%Y') %></th>
    <th><%= (Date.today + 7.day).strftime('%d/%m/%Y') %></th>
    </thead>
    <tbody>
    <% @vehicles.each do |vehicle| %>
        <% user_vehicles = vehicle.user_vehicles.where('end_date <= ? OR end_date IS NULL', Date.today + 7.day)
            date = Date.today
        %>
        <tr>
          <td><%= vehicle.vehicle_number %></td>
          <% if user_vehicles.length > 1 %>
              <% user_vehicles.each do |uv| %>
                <% if uv.end_date.present? %>
                  <% loop do %>
                    <td>
                      <%= uv.user.name %>
                    </td>
                    <% date = date + 1.day %>
                  <% break if date == uv.end_date.to_date %>
                  <% end %>
                <% else %>
                  <% loop do %>
                      <td>
                        <%= uv.user.name %>
                      </td>
                      <% date = date + 1.day %>
                      <% break if date == Date.today + 8.day %>
                  <% end %>
                <% end %>
              <% end %>
          <% elsif user_vehicles.length == 1 %>
            <% uv = user_vehicles.first %>
            <% loop do %>
                <td>
                  <%= uv.user.name %>
                </td>
                <% date = date + 1.day %>
                <% break if date == Date.today + 8.day %>
            <% end %>
          <% end %>
        </tr>
    <% end %>
    </tbody>
  </table>
</div>

<script type="text/javascript">
    $(document).ready(function(){
       $("#vehicle_id").change(function(){
           var vehicle_id = $("#vehicle_id").val();
           var start_date  = $("#start_date").val();
           $("#user_id").addClass('hidden');
           $select = $("#user_id");
           $select.html('');
           $('#error-message').text('');
           $('#error-message').addClass('hidden');
            if (vehicle_id > 0 || vehicle_id > "0")
            {
                $.ajax({
                    url: '/vehicles/get_users?vehicle_id=' + $(this).val() + '&start_date=' + start_date,
                    dataType:'JSON',
                    success:function(data){
                        if (data.status == false)
                        {
                          if (confirm('This vehicle already assigned. do you want to assign to another?')) {
                            $('#error-message').text('');
                            $('#error-message').text('This vehicle already assigned. Please assign to another.');
                            $('#error-message').removeClass('hidden');
                              $select = $("#user_id");
                              $select.html('');
                              $select.html('<option value = "-1">Select user</option>');
                              //iterate over the data and append a select option
                              $.each(data.users, function(key, val){
                                  $select.append('<option value="' + val.id + '" name="' + val.id + '" >' + val.name + '</option>');
                              })
                              $("#user_id").removeClass('hidden');

                          } else {
                            $('#error-message').text('');
                            $('#error-message').text('This vehicle already assigned.');
                            $('#error-message').removeClass('hidden');
                          }
                        }else
                        {
                          $select = $("#user_id");
                          $select.html('');
                          $select.html('<option value = "-1">Select user</option>');
                          //iterate over the data and append a select option
                          $.each(data.users, function(key, val){
                              $select.append('<option value="' + val.id + '" name="' + val.id + '" >' + val.name + '</option>');
                          })
                          $("#user_id").removeClass('hidden');
                        }

                    },
                    error:function(){
                        //if there is an error append a 'none available' option
                        // $select.html('<option id="-1">none available</option>');
                    }
                });
            }
        });
       $("#user_id").change(function(){
           var val = $("#user_id").val();
           if(val > 0 || val > '0')
           {$('#submit_button').removeClass('disabled');
           }else{$('#submit_button').addClass('disabled');}
       });
    })
</script>